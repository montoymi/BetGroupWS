<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PollaHeaders">
    <resultMap id="selectResult" type="PollaHeader">
        <result property="pollaId" column="id"/>
        <result property="pollaName" column="polla_name"/>
        <result property="templateHeaderId" column="template_header_id"/>
        <result property="adminId" column="admin_user_id"/>
        <result property="admin.userId" column="user_id"/>
        <result property="admin.username" column="nickname"/>
        <result property="admin.email" column="email_address"/>
        <result property="admin.firstName" column="first_name"/>
        <result property="admin.lastName" column="last_name"/>
        <result property="pollaCost" column="credit_amount"/>
        <result property="accessFlag" column="access_flag"/>
        <result property="enabled_flag" column="status"/>
        <result property="password" column="password"/>
        <result property="costFlag" column="cost_flag"/>
        <result property="image" column="image"/>
        <result property="numWildcards" column="num_wildcard"/>
        <result property="image" column="image"/>
        <result property="modePollaFlag" column="mode_polla_flg"/>
        <result property="modePollitaFlag" column="mode_pollita_flg"/>
        <result property="modeWildcardFlag" column="mode_wildcard_flg"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="total_bet" column="total_bet"/>

    </resultMap>

    <select id="getMisPollasByUserId" parameterType="int" resultMap="selectResult">
        SELECT ph.* FROM polla_headers AS ph, polla_participants AS pp
        WHERE ph.id = pp.polla_header_id AND pp.user_id = #{userId} and ph.status = 1
        ORDER BY ph.start_date, end_date, polla_name
    </select>

    <select id="getPollasDisponiblesByUserId" parameterType="PollaHeader" resultMap="selectResult">
        select * from polla_headers as ph
        where not exists (select 1
        from polla_participants pp
        where pp.polla_header_id = ph.id
        and pp.user_id = #{userId} ) and ph.status = 1
        order by ph.start_date, ph.end_date, ph.polla_name
    </select>

    <select id="createBetGroup" statementType="CALLABLE" parameterType="map">
        { call xx_create_betgroup (
            #{pollaHeader.pollaName, mode=IN, jdbcType=VARCHAR},
            #{pollaHeader.accessFlag, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.password, mode=IN, jdbcType=VARCHAR},
            #{pollaHeader.costFlag, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.pollaCost, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.adminId, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.templateHeaderId, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.modePollaFlag, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.modePollitaFlag, mode=IN, jdbcType=INTEGER},
            #{pollaHeader.modeWildcardFlag, mode=IN, jdbcType=INTEGER},
            #{mensaje,mode=OUT, jdbcType=VARCHAR }
        )}
    </select>

    <select id="getPollaById" parameterType="int" resultMap="selectResult">
        SELECT ph.* FROM polla_headers AS ph
        WHERE ph.id = #{id}
    </select>

    <select id="validatePollaPassword" parameterType="PollaHeader" resultType="int">
        SELECT count(1)
        FROM polla_headers ph
        WHERE ph.id = #{pollaId} AND ph.password = #{password}
    </select>


</mapper>